spool /home/plan/ShinyApps/aps/producao/base_de_dados/extraidas/odonto/odonto.csv
set sqlformat csv  
set feedback off  

SELECT DISTRITO       ,UNIDADE       ,AREA       ,extract(year from dia_atd) as ano       ,extract(month from dia_atd) as mes       ,COUNT(DISTINCT(CASE WHEN (COD_PROCEDIMENTO = '0301010153') THEN COD_CONSULTA END)) AS PRIM_CONS_ODO       ,COUNT(DISTINCT(CASE WHEN (COD_PROCEDIMENTO = '90022') THEN COD_CONSULTA END)) AS TC       ,COUNT((CASE WHEN COD_PROCEDIMENTO NOT IN ('90022','0301010153','0301010030','0301010048','0301010099','0301010080','908080','0101030029','0301010137','0301010161') THEN COD_CONSULTA END)) AS PROCEDIMENTOS                                       FROM ((  SELECT REG.NM_REGIAO AS DISTRITO       ,UNI.NM_UNIDADE AS UNIDADE       ,LGR.CD_AREA AS AREA       ,CON.CD_CONSULTA AS COD_CONSULTA       ,CON.CD_USUARIO AS COD_USUARIO       ,CON.CD_PROCEDIMENTO AS COD_PROCEDIMENTO       ,TO_DATE(CON.DT_INICIO, 'dd/mm/RRRR') AS DIA_ATD                                         FROM VIA_CONSULTA CON LEFT JOIN VIP_USUARIO USU ON CON.CD_USUARIO = USU.CD_USUARIO LEFT JOIN VSG_LOGRADOURO LGR ON GET_LOGRADOURO( USU.nm_logradouro, USU.cd_tipo_logradouro, USU.nu_logradouro_casa, USU.cd_bairro ) = LGR.CD_LOGRADOURO LEFT JOIN VSC_UNIDADE UNI ON LGR.CD_UNIDADE = UNI.CD_UNIDADE LEFT JOIN VSG_REGIAO REG ON UNI.CD_REGIAO = REG.CD_REGIAO LEFT JOIN VIC_PROFISSIONAL PRO ON CON.CD_PROFISSIONAL = PRO.CD_PROFISSIONAL LEFT JOIN VIC_ESPECIALIDADE ESP ON PRO.CD_ESPECIALIDADE = ESP.CD_ESPECIALIDADE LEFT JOIN VSC_UNIDADE UNI2 ON TRUNC(CON.CD_CONSULTA / 10000000) = UNI2.CD_UNIDADE_INTERNO    WHERE (CON.DT_AGENDA >= TRUNC(ADD_MONTHS(SYSDATE,-3),'MONTH') AND CON.DT_AGENDA < TRUNC(SYSDATE,'MONTH')) AND PRO.CD_ESPECIALIDADE IN ('57','58','59','60','61','6','83','167','145','144','105','155','162','98','104','108','111','153') AND UNI.NM_UNIDADE LIKE 'CS%' AND UNI2.NM_UNIDADE LIKE 'CS%'    ) UNION ALL (  SELECT REG.NM_REGIAO AS DISTRITO       ,UNI.NM_UNIDADE AS UNIDADE       ,LGR.CD_AREA AS AREA       ,CON.CD_CONSULTA COD_CONSULTA       ,CON.CD_USUARIO AS COD_USUARIO       ,OUC.CD_PROCEDIMENTO AS COD_PROCEDIMENTO       ,TO_DATE(CON.DT_INICIO, 'dd/mm/RRRR') AS DIA_ATD                                     FROM VIA_CONSULTA CON LEFT JOIN VIP_USUARIO USU ON CON.CD_USUARIO = USU.CD_USUARIO LEFT JOIN VSG_LOGRADOURO LGR ON GET_LOGRADOURO( USU.nm_logradouro, USU.cd_tipo_logradouro, USU.nu_logradouro_casa, USU.cd_bairro ) = LGR.CD_LOGRADOURO LEFT JOIN VSC_UNIDADE UNI ON LGR.CD_UNIDADE = UNI.CD_UNIDADE LEFT JOIN VSG_REGIAO REG ON UNI.CD_REGIAO = REG.CD_REGIAO LEFT JOIN VIP_OUTRA_CONSULTA OUC ON CON.CD_CONSULTA = OUC.CD_CONSULTA LEFT JOIN VIC_PROFISSIONAL PRO ON CON.CD_PROFISSIONAL = PRO.CD_PROFISSIONAL LEFT JOIN VIC_ESPECIALIDADE ESP ON PRO.CD_ESPECIALIDADE = ESP.CD_ESPECIALIDADE LEFT JOIN VSC_UNIDADE UNI2 ON TRUNC(CON.CD_CONSULTA / 10000000) = UNI2.CD_UNIDADE_INTERNO      WHERE (CON.DT_AGENDA >= TRUNC(ADD_MONTHS(SYSDATE,-3),'MONTH') AND CON.DT_AGENDA < TRUNC(SYSDATE,'MONTH')) AND PRO.CD_ESPECIALIDADE IN ('57','58','59','60','61','6','83','167','145','144','105','155','162','98','104','108','111','153') AND UNI.NM_UNIDADE LIKE 'CS%' AND UNI2.NM_UNIDADE LIKE 'CS%'   ) UNION ALL (  SELECT REG.NM_REGIAO AS DISTRITO       ,UNI.NM_UNIDADE AS UNIDADE       ,LGR.CD_AREA AS AREA       ,CON.CD_CONSULTA AS COD_CONSULTA       ,CON.CD_USUARIO AS COD_USUARIO       ,PMT.CD_PROCEDIMENTO_BPA AS COD_PROCEDIMENTO       ,TO_DATE(CON.DT_INICIO, 'dd/mm/RRRR') AS DIA_ATD                              FROM VIA_CONSULTA CON LEFT JOIN VIP_USUARIO USU ON CON.CD_USUARIO = USU.CD_USUARIO LEFT JOIN VSG_LOGRADOURO LGR ON GET_LOGRADOURO( USU.nm_logradouro, USU.cd_tipo_logradouro, USU.nu_logradouro_casa, USU.cd_bairro ) = LGR.CD_LOGRADOURO LEFT JOIN VSC_UNIDADE UNI ON LGR.CD_UNIDADE = UNI.CD_UNIDADE LEFT JOIN VSG_REGIAO REG ON UNI.CD_REGIAO = REG.CD_REGIAO LEFT JOIN VIP_PROCEDIMENTO PMT ON CON.CD_CONSULTA = PMT.CD_CONSULTA LEFT JOIN VIC_PROFISSIONAL PRO ON CON.CD_PROFISSIONAL = PRO.CD_PROFISSIONAL LEFT JOIN VIC_ESPECIALIDADE ESP ON PRO.CD_ESPECIALIDADE = ESP.CD_ESPECIALIDADE LEFT JOIN VSC_UNIDADE UNI2 ON TRUNC(CON.CD_CONSULTA / 10000000) = UNI2.CD_UNIDADE_INTERNO    WHERE (CON.DT_AGENDA >= TRUNC(ADD_MONTHS(SYSDATE,-3),'MONTH') AND CON.DT_AGENDA < TRUNC(SYSDATE,'MONTH')) AND PRO.CD_ESPECIALIDADE IN ('57','58','59','60','61','6','83','167','145','144','105','155','162','98','104','108','111','153') AND UNI.NM_UNIDADE LIKE 'CS%' AND UNI2.NM_UNIDADE LIKE 'CS%'   ))  WHERE DIA_ATD IS NOT NULL  GROUP BY DISTRITO       ,UNIDADE       ,AREA       ,extract(year from dia_atd)       ,extract(month from dia_atd)  ORDER BY  DISTRITO       ,UNIDADE       ,AREA       ,extract(year from dia_atd)       ,extract(month from dia_atd)        ; 

spool off 

exit 
 
EOF
