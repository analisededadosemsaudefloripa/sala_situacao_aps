spool /home/plan/ShinyApps/aps/producao/base_de_dados/extraidas/testes_rapidos/testes_rapidos.csv
set sqlformat csv  
set feedback off  

SELECT DISTRITO       ,UNIDADE       ,AREA       ,EXTRACT(YEAR FROM DIA) AS ANO       ,EXTRACT(MONTH FROM DIA) AS MES       ,COD_PROCEDIMENTO       ,COUNT(TABELA.COD_PROCEDIMENTO) AS QUANTIDADE   FROM  ( (  SELECT REG.NM_REGIAO AS DISTRITO       ,UNI.NM_UNIDADE AS UNIDADE       ,LGR.CD_AREA AS AREA       ,CON.CD_PROCEDIMENTO AS COD_PROCEDIMENTO       ,CON.DT_AGENDA AS DIA                FROM VIA_CONSULTA CON LEFT JOIN VIP_OUTRA_CONSULTA OUC ON CON.CD_CONSULTA = OUC.CD_CONSULTA LEFT JOIN VIC_PROFISSIONAL PRO ON CON.CD_PROFISSIONAL = PRO.CD_PROFISSIONAL LEFT JOIN VIP_USUARIO USU ON CON.CD_USUARIO = USU.CD_USUARIO LEFT JOIN VSG_LOGRADOURO LGR ON GET_LOGRADOURO( USU.nm_logradouro, USU.cd_tipo_logradouro, USU.nu_logradouro_casa, USU.cd_bairro ) = LGR.CD_LOGRADOURO LEFT JOIN VSC_UNIDADE UNI ON LGR.CD_UNIDADE = UNI.CD_UNIDADE LEFT JOIN VSG_REGIAO REG ON UNI.CD_REGIAO = REG.CD_REGIAO LEFT JOIN VSC_UNIDADE UNI2 ON TRUNC(CON.CD_CONSULTA / 10000000) = UNI2.CD_UNIDADE_INTERNO  WHERE (CON.dt_agenda >= TRUNC(ADD_MONTHS(SYSDATE,-3),'MONTH') AND CON.dt_agenda < TRUNC(SYSDATE,'MONTH')) AND CON.CD_PROCEDIMENTO IN ('0214010040','0214010058','0214010074','0214010082','0214010090','0214010104') AND UNI.NM_UNIDADE LIKE 'CS%' AND UNI2.NM_UNIDADE LIKE 'CS%'  )  UNION ALL (  SELECT REG.NM_REGIAO AS DISTRITO       ,UNI.NM_UNIDADE AS UNIDADE       ,LGR.CD_AREA AS AREA       ,PMT.CD_PROCEDIMENTO_BPA AS COD_PROCEDIMENTO       ,CON.DT_AGENDA AS DIA         FROM VIA_CONSULTA CON LEFT JOIN VIP_PROCEDIMENTO PMT ON CON.CD_CONSULTA = PMT.CD_CONSULTA LEFT JOIN VIC_PROFISSIONAL PRO ON CON.CD_PROFISSIONAL = PRO.CD_PROFISSIONAL LEFT JOIN VIP_USUARIO USU ON CON.CD_USUARIO = USU.CD_USUARIO LEFT JOIN VSG_LOGRADOURO LGR ON GET_LOGRADOURO( USU.nm_logradouro, USU.cd_tipo_logradouro, USU.nu_logradouro_casa, USU.cd_bairro ) = LGR.CD_LOGRADOURO LEFT JOIN VSC_UNIDADE UNI ON LGR.CD_UNIDADE = UNI.CD_UNIDADE LEFT JOIN VSG_REGIAO REG ON UNI.CD_REGIAO = REG.CD_REGIAO LEFT JOIN VSC_UNIDADE UNI2 ON TRUNC(CON.CD_CONSULTA / 10000000) = UNI2.CD_UNIDADE_INTERNO  WHERE (CON.dt_agenda >= TRUNC(ADD_MONTHS(SYSDATE,-3),'MONTH') AND CON.dt_agenda < TRUNC(SYSDATE,'MONTH')) AND PMT.CD_PROCEDIMENTO_BPA IN ('0214010040','0214010058','0214010074','0214010082','0214010090','0214010104') AND UNI.NM_UNIDADE LIKE 'CS%' AND UNI2.NM_UNIDADE LIKE 'CS%' ) ) TABELA    GROUP BY DISTRITO       ,UNIDADE       ,AREA       ,COD_PROCEDIMENTO       ,EXTRACT(YEAR FROM DIA)       ,EXTRACT(MONTH FROM DIA)         ORDER BY DISTRITO       ,UNIDADE       ,AREA       ,COD_PROCEDIMENTO       ,EXTRACT(YEAR FROM DIA)       ,EXTRACT(MONTH FROM DIA)         ; 

spool off 

exit 
 
EOF
