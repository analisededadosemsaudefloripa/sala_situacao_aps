spool /home/plan/ShinyApps/aps/producao/base_de_dados/extraidas/faltas/faltas.csv
set sqlformat csv  
set feedback off  

SELECT DISTRITO       ,UNIDADE       ,AREA       ,EXTRACT(YEAR FROM DIA_CONSULTA_2) AS ANO       ,EXTRACT(MONTH FROM DIA_CONSULTA_2) AS MES       ,COUNT(DISTINCT(CASE WHEN (ESPECIALIDADE IN ('2') AND (PROC1 NOT IN ('908080','90079','90078','90159') OR PROC2 NOT IN ('908080','90079','90078','90159') OR PROC3 NOT IN ('908080','90079','90078','90159'))) THEN CONSULTA END)) AS CONS_ENF       ,COUNT(DISTINCT(CASE WHEN (ESPECIALIDADE IN ('152','165','5') AND (PROC1 NOT IN ('908080','90079','90078','90159') OR PROC2 NOT IN ('908080','90079','90078','90159') OR PROC3 NOT IN ('908080','90079','90078','90159'))) THEN CONSULTA END)) AS CONS_MED       ,COUNT(DISTINCT(CASE WHEN (ESPECIALIDADE IN ('83','6')  AND (PROC1 NOT IN ('908080','90079','90078','90159') OR PROC2 NOT IN ('908080','90079','90078','90159') OR PROC3 NOT IN ('908080','90079','90078','90159'))) THEN CONSULTA END)) AS CONS_ODO       ,COUNT(DISTINCT(CASE WHEN (ESPECIALIDADE IN ('2') AND (PROC1 IN ('908080') OR PROC2 IN ('908080') OR PROC3 IN ('908080') OR DIA_CONSULTA_3 IS NULL)) THEN CONSULTA END)) AS FALTAS_ENF       ,COUNT(DISTINCT(CASE WHEN (ESPECIALIDADE IN ('152','165','5') AND (PROC1 IN ('908080') OR PROC2 IN ('908080') OR PROC3 IN ('908080') OR DIA_CONSULTA_3 IS NULL)) THEN CONSULTA END)) AS FALTAS_MED       ,COUNT(DISTINCT(CASE WHEN (ESPECIALIDADE IN ('83','6')  AND (PROC1 IN ('908080') OR PROC2 IN ('908080') OR PROC3 IN ('908080') OR DIA_CONSULTA_3 IS NULL)) THEN CONSULTA END)) AS FALTAS_ODO   FROM (  SELECT REG.NM_REGIAO AS DISTRITO       ,UNI.NM_UNIDADE AS UNIDADE       ,LGR.CD_AREA AS AREA       ,CON.CD_CONSULTA AS CONSULTA       ,PRO.CD_ESPECIALIDADE AS ESPECIALIDADE       ,CON.CD_PROCEDIMENTO AS PROC1       ,OUC.CD_PROCEDIMENTO AS PROC2       ,PMT.CD_PROCEDIMENTO_BPA AS PROC3       ,TO_DATE(CON.DT_AGENDA, 'dd/mm/RRRR') AS DIA_CONSULTA_2       ,TO_DATE(CON.DT_INICIO, 'dd/mm/RRRR') AS DIA_CONSULTA_3                                                 FROM VIA_CONSULTA CON LEFT JOIN VIC_PROFISSIONAL PRO ON CON.CD_PROFISSIONAL = PRO.CD_PROFISSIONAL LEFT JOIN VIP_OUTRA_CONSULTA OUC ON CON.CD_CONSULTA = OUC.CD_CONSULTA LEFT JOIN VIP_PROCEDIMENTO PMT ON CON.CD_CONSULTA = PMT.CD_CONSULTA LEFT JOIN VIP_USUARIO USU ON CON.CD_USUARIO = USU.CD_USUARIO LEFT JOIN VSG_LOGRADOURO LGR ON GET_LOGRADOURO( USU.nm_logradouro, USU.cd_tipo_logradouro, USU.nu_logradouro_casa, USU.cd_bairro ) = LGR.CD_LOGRADOURO LEFT JOIN VSC_UNIDADE UNI ON LGR.CD_UNIDADE = UNI.CD_UNIDADE LEFT JOIN VSG_REGIAO REG ON UNI.CD_REGIAO = REG.CD_REGIAO LEFT JOIN VSC_UNIDADE UNI2 ON TRUNC(CON.CD_CONSULTA / 10000000) = UNI2.CD_UNIDADE_INTERNO   WHERE (CON.DT_AGENDA >= TRUNC(ADD_MONTHS(SYSDATE,-3),'MONTH') AND CON.DT_AGENDA < TRUNC(SYSDATE,'MONTH')) AND UNI.NM_UNIDADE LIKE 'CS%' AND UNI2.NM_UNIDADE LIKE 'CS%'  ) T   GROUP BY DISTRITO, UNIDADE, AREA ,EXTRACT(YEAR FROM DIA_CONSULTA_2) ,EXTRACT(MONTH FROM DIA_CONSULTA_2)  ORDER BY DISTRITO, UNIDADE, AREA ,EXTRACT(YEAR FROM DIA_CONSULTA_2) ,EXTRACT(MONTH FROM DIA_CONSULTA_2)  ; 

spool off 

exit 
 
EOF
