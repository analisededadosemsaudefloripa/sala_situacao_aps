spool /home/plan/ShinyApps/aps/producao/base_de_dados/extraidas/gestantes/gestantes.csv
set sqlformat csv  
set feedback off  

SELECT DISTRITO        ,UNIDADE        ,AREA        ,ANO        ,MES        ,COUNT(USUARIO) AS GESTANTES       ,COUNT(CASE WHEN CONSULTAS >= 7 THEN USUARIO END) AS GESTANTES_7_CONS        ,COUNT(CASE WHEN CONS_PRI_TRI > 0 AND CONS_SEG_TRI > 0 AND CONS_TER_TRI > 0 THEN USUARIO END) AS GEST_TODOS_TRI       ,COUNT(CASE WHEN CONSULTAS_ODONTO > 0 THEN USUARIO END) AS GEST_ODONTO        FROM (   SELECT DISTRITO, UNIDADE, AREA,USUARIO, ANO, MES        ,COUNT(CASE WHEN (ESPECIALIDADE IN ('2','152','165','5','19','40')) AND (DIA_CONSULTA < SEG_TRI AND DIA_CONSULTA >= PRI_TRI) THEN CONSULTA END) AS CONS_PRI_TRI       ,COUNT(CASE WHEN (ESPECIALIDADE IN ('2','152','165','5','19','40')) AND (DIA_CONSULTA < TER_TRI AND DIA_CONSULTA >= SEG_TRI) THEN CONSULTA END) AS CONS_SEG_TRI       ,COUNT(CASE WHEN (ESPECIALIDADE IN ('2','152','165','5','19','40')) AND (DIA_CONSULTA <= PARTO AND DIA_CONSULTA >= TER_TRI) THEN CONSULTA END) AS CONS_TER_TRI       ,COUNT(DISTINCT(CASE WHEN (ESPECIALIDADE IN ('2','152','165','5','19','40')) THEN CONSULTA END)) AS CONSULTAS       ,COUNT(CASE WHEN (ESPECIALIDADE IN ('6','83')) THEN CONSULTA END) AS CONSULTAS_ODONTO  FROM (   SELECT REG.NM_REGIAO AS DISTRITO        ,UNI.NM_UNIDADE AS UNIDADE        ,LGR.CD_AREA AS AREA        ,EXTRACT(YEAR FROM PEF.DT_PROVAVEL_PARTO) AS ANO        ,EXTRACT(MONTH FROM PEF.DT_PROVAVEL_PARTO) AS MES        ,CON.CD_CONSULTA AS CONSULTA        ,CON.CD_USUARIO AS USUARIO       ,PEF.DT_ULTIMA_MENSTRUACAO AS DUM       ,CON.DT_INICIO AS DIA_CONSULTA       ,COALESCE(PEU.DT_PARTO,PEF.DT_PROVAVEL_PARTO) AS PARTO       ,PRO.CD_ESPECIALIDADE AS ESPECIALIDADE       ,PEF.DT_PROVAVEL_PARTO - 93 AS TER_TRI       ,PEF.DT_PROVAVEL_PARTO - 186 AS SEG_TRI       ,PEF.DT_PROVAVEL_PARTO - 280 AS PRI_TRI                      FROM VIP_PRENATAL_FICHA PEF LEFT JOIN VIP_PRENATAL_CONSULTA PEC ON PEF.CD_PRENATAL = PEC.CD_PRENATAL LEFT JOIN VIP_PRENATAL_PARTO_PUERP PEU ON PEC.CD_PRENATAL = PEU.CD_PRENATAL LEFT JOIN VIA_CONSULTA CON ON PEC.CD_CONSULTA = CON.CD_CONSULTA LEFT JOIN VIP_OUTRA_CONSULTA OUC ON CON.CD_CONSULTA = OUC.CD_CONSULTA LEFT JOIN VIP_PROCEDIMENTO PMT ON CON.CD_CONSULTA = PMT.CD_CONSULTA LEFT JOIN VIP_USUARIO USU ON CON.CD_USUARIO = USU.CD_USUARIO LEFT JOIN VSG_LOGRADOURO LGR ON GET_LOGRADOURO( USU.nm_logradouro, USU.cd_tipo_logradouro, USU.nu_logradouro_casa, USU.cd_bairro ) = LGR.CD_LOGRADOURO LEFT JOIN VSC_UNIDADE UNI ON LGR.CD_UNIDADE = UNI.CD_UNIDADE LEFT JOIN VSG_REGIAO REG ON UNI.CD_REGIAO = REG.CD_REGIAO LEFT JOIN VIC_PROFISSIONAL PRO ON CON.CD_PROFISSIONAL = PRO.CD_PROFISSIONAL  WHERE (PEF.DT_PROVAVEL_PARTO >= TRUNC(ADD_MONTHS(SYSDATE,-3),'MONTH') AND PEF.DT_PROVAVEL_PARTO < TRUNC(SYSDATE,'MONTH')) AND UNI.NM_UNIDADE LIKE 'CS%' AND PEF.DT_INTERRUPCAO IS NULL AND (CON.CD_PROCEDIMENTO NOT IN ('908080','90078','90079','90159') OR OUC.CD_PROCEDIMENTO NOT IN ('908080','90078','90079','90159') OR PMT.CD_PROCEDIMENTO_BPA NOT IN ('908080','90078','90079','90159')) AND PRO.CD_ESPECIALIDADE IN ('2','152','165','5','19','40','6','83') AND TRUNC(CON.CD_CONSULTA / 10000000) NOT IN (109,55)  )   GROUP BY DISTRITO, UNIDADE, AREA, USUARIO, ANO, MES  ORDER BY DISTRITO, UNIDADE, AREA, USUARIO, ANO, MES  )  GROUP BY DISTRITO, UNIDADE, AREA, ANO, MES  ORDER BY DISTRITO, UNIDADE, AREA, ANO, MES  ;

spool off 

exit 
 
EOF
